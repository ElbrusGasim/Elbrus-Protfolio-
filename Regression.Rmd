---
title: "Regression"
author: "Elbrus Gasimov, Gunneet Singh"
date: "6/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##introduction

The project relies on accuracy of data. The data-set related to life expectancy, health factors for 193 countries has been collected from the same WHO data repository website and its corresponding economic data was collected from United Nation website. Among all categories of health-related factors only those critical factors were chosen which are more representative.In this project we have considered data from year 2000-2015 for 193 countries for further analysis. The individual data files have been merged together into a single data-set. On initial visual inspection of the data showed some missing values. As the data-sets were from WHO, we found no evident errors. Missing data was handled in R software by using Missmap command. The result indicated that most of the missing data was for population, Hepatitis B and GDP. The missing data were from less known countries like Vanuatu, Tonga, Togo, Cabo Verde etc. Finding all data for these countries was difficult and hence, it was decided that we exclude these countries from the final model data-set. The final merged file(final dataset) consists of 22 Columns and 2938 rows which meant 20 predicting variables. All predicting variables was then divided into several broad categories:Immunization related factors, Mortality factors, Economical factors and Social factors.


## Importing the required packages and libraries

```{r}
#install.packages('ggplot2')
#install.packages('corrplot')
#install.packages('dplyr')
#install.packages('caret')
#install.packages('superml')
#install.packages('rpart')
#install.packages('rpart.plot')
#install.packages('Metrics')
#install.packages('randomForest')

library(ggplot2)
library(corrplot)
library(dplyr)
library(caret)
library(superml)
library(rpart)
library(rpart.plot)
library(Metrics)
library(randomForest)
```

## The data is saved as a csv file namely Life Expectancy Data.csv

## Importing the data
```{r pressure, echo=FALSE}
data <- read.csv('Life Expectancy Data.csv')
```

The dataset includes 2938 observations and 22 variables.
It contains information about the following variables:

Country - Names of the countries
Year - Year of observations
Status - whether developed or developing
Life Expectancy - Average time a citizen of any country is expected to live(in years)
Adult Mortality - Probability of dying between 15 and 60 years per 1000 population
Infant deaths - Number of Infant Deaths per 1000 population
Alcohol - Alcohol, recorded per capita (15+) consumption (in litres)
Percentage expenditure - Expenditure on health as a percentage of GDP per capita(%)
Hepatitis B - Immunization coverage among 1-year olds (%)
Measles - Number of reported cases per 1000 population
BMI - Average Body Mass Index of entire population under-five deaths - Number of under-five deaths per 1000 population
Polio - Immunization coverage among 1-year olds (%)
Total expenditure - Government expenditure on health industry as a percentage of total government expenditure(%)
Diphtheria - Immunization coverage among 1-year olds (%)
HIV/AIDS - Deaths per 1 000 live births HIV/AIDS (0-4 years)
GDP - Gross Domestic Product per capita (in USD)
Population - Population of the country
Thinness 10-19 years - Prevalence of thinness among children and adolescents for Age 10 to 19 (% )
Thinness 5-9 years - Prevalence of thinness among children for Age 5 to 9(%)
Income composition of resources - Human Development Index in terms of income
composition of resources (index ranging from 0 to 1)
Schooling - Number of years of Schooling

The data related to life expectancy, health factors for 193 countries has been collected from the Global Health Observatory (GHO) data repository under the
World Health Organization (WHO) and its corresponding economic data was collected from the United Nation website for a period of 16 years(2000-2015). 
The dataset is made available on Kaggle- https://www.kaggle.com/kumarajarshi/life-expectancy-who

 Basic Exploratory Data Analysis 

Viewing Data

```{r}
View(data)
```

Checking the structure of the data

```{r}
str(data)
```


Viewing the data type of each column of data

```{r}
sapply(data, FUN=class)
```

Checking values in status Column with frequency table

```{r}
statusTable <- table(data$Status)
statusTable <- as.data.frame(statusTable)
head(statusTable)
prop.table(table(data$Status))
```

Checking the proportion of countries for whom life expectancy is more than 70

```{r}
table(data$Status[data$Life.expectancy>70.0])
```

## Basic EDA for health related variables.

Plotting different histograms to show the distribution of the variables along  with any skewness they might have.

```{r}
par(mfrow=c(3,3))
par(mar=c(3,2,1,1))
hist(data$infant.deaths)
hist(data$Adult.Mortality)
hist(data$Alcohol)
hist(data$Hepatitis.B)
hist(data$Measles)
hist(data$Polio)
hist(data$Diphtheria)
```

Plotting the ratio of developing vs developed Countries

```{r}
ggplot(data = statusTable, aes(x=Var1, y=Freq))+
  geom_bar(stat='identity')
```


Plotting the correlation graph between variables

```{r}
nums <- unlist(lapply(data, is.numeric))  
data[ , nums]
cormat <- cor(data[, nums],use='pairwise.complete.obs')
corrplot(cormat,type = 'lower')
```


## Analysis of Correlation:
Adult Mortality is negatively Correlated to Life Expectancy on a significant scale.
Under-5 deaths is positively correlated to infants deaths on a significant scale.
HIV AIDS is negatively correlated to Life Expectancy on a significant scale.
GDP is positively correlated with percentage expenditure on a significant scale.
Thinness is negatively correlated to Life Expectancy on a significant scale.
Schooling is positively correlated to Life Expectancy on a significant scale.

Life Expectancy is the target variable for our modeling purpose. 
The features are expected to be independent.
High Correlation between the features is a sign of multicollinearity. We should treat it.

## Data Cleaning
Identifying the total NA Values in each column

```{r}
sapply(data, function(x) sum(is.na(x)))
```


## Imputing NA values:
## for column 'Life Expectancy'

```{r}
data$Life.expectancy[is.na(data$Life.expectancy)] <- 
  mean(data$Life.expectancy, na.rm=TRUE)

sapply(data, function(x) sum(is.na(x)))
```

## For column 'Adult Mortality'

```{r}
data$Adult.Mortality[is.na(data$Adult.Mortality)] <- mean(data$Adult.Mortality, na.rm=TRUE)
```

## Now, instead of imputing the mean values of the whole column, we can impute the values of mean of range to make it more precise.

Imputing Alcohol Values in relation to the Schooling Values
For this, lets first create a scatterplot and analyze.

```{r}
ggplot(data=data, aes(x=Alcohol, y=Schooling))+
  geom_point()
impute_alcohol <- function(values){
  alcoholValue <- as.numeric(values[1])
  schoolingValue <- as.numeric(values[2])
  if(is.na(alcoholValue) == TRUE && is.na(schoolingValue) == FALSE){
    if(schoolingValue <= 2.5){
      return(4.0)
    } else if(2.5<schoolingValue && schoolingValue<=5.0){
      return(1.5)
    } else if(5.0<schoolingValue && schoolingValue<=7.5){
      return(2.5)
    } else if(7.5<schoolingValue && schoolingValue<=10.0){
      return(3.0)
    } else if(10.0<schoolingValue && schoolingValue<=15.0){
      return(4.0)
    } else if(schoolingValue>15.0){
      return(10.0)
    }
  }
  else{
    return(alcoholValue)
  }
}
school_alcohol <- data[c('Alcohol','Schooling')]
data$Alcohol <- apply(school_alcohol, FUN=impute_alcohol, MARGIN=1)
sapply(data, function(x) sum(is.na(x)))
```

As there are still 9 NA's in the Alcohol variable, lets further Impute values with Mean.

```{r}
data$Alcohol[is.na(data$Alcohol)] <- mean(data$Alcohol, na.rm=TRUE)
```

## Imputing Polio in regards to the Life Expectancy

```{r}
ggplot(data,aes(x=Polio, y=Life.expectancy))+
  geom_point()
impute_polio <- function(values){
  polio=as.numeric(values[1])
  le=as.numeric(values[2])
  if(is.na(polio) == TRUE ){
    if(le <= 45.0){
      return(80.0)
    } else if(45.0<le && le<=50.0){
      return(67.0)
    } else if(50.0<le && le<=60.0){
      return(87.44)
    } else if(60.0<le && le<= 70.0){
      return(91.0)
    } else if(70.0<le && le<=80.0){
      return(94.0)
    } else if(le > 80.0){
      return(95.0)
    }
  }
  else{
    return(polio)
  }
}

polio_lifeExpect <- data[c('Polio','Life.expectancy')]
data$Polio<- apply(polio_lifeExpect,FUN=impute_polio, MARGIN=1)
```

## Imputing diphtheria with regards to Polio

```{r}
ggplot(data, aes(x=Polio, y=Diphtheria))+
  geom_point(na.rm=TRUE)

impute_diphtheria <- function(values){
  d <- as.numeric(values[1])
  p <- as.numeric(values[2])
  if(is.na(d) == TRUE){
    if( p<=10){
      return(75.0)
    }
  else if( 10<p && p<=40){
    return(37.0)
  }
  else if (40<p && p<=45){
    return(40.0)
  }
  else if (45<p && p<=50){
    return(50.0)
  }
  else if( 50<p && p<=60){
    return(55.0)
  }
  else if( 60<p && p<=80){
    return(65.0)
  }
  else if (p>80){
    return( 90.0)
    }
  }
  else{
    return(d)
  }
}

dip_polio <- data[c('Diphtheria','Polio')]
data$Diphtheria <- apply(dip_polio, FUN=impute_diphtheria, MARGIN=1)
```


##  Imputing Hepatitis with diphtheria

```{r}
ggplot(data, aes(x=Hepatitis.B, y=Diphtheria))+
  geom_point(na.rm=TRUE)
impute_hep <- function(values){
  hep<- as.numeric(values[1])
  dip <- as.numeric(values[2])
  if(is.na(hep) ==TRUE){
    if (dip<=15){
    return (75.0)}
  else if (15<dip && dip<=30){
    return (20.0)}
  else if (30<dip && dip<=45){
    return (38.0)}
  else if (45<dip && dip<=60){
    return( 43.0)}
  else if (60<dip && dip<=80){
    return (63.0)
  }
  else if( dip>80){
    return (88.4)
    }
  }
  else{
    return (hep)
  }
}

hep_dip <- data[c('Hepatitis.B','Diphtheria')]
data$Hepatitis.B <- apply(hep_dip, FUN=impute_hep, MARGIN=1)
```


## Imputing BMI with life expectancy

```{r}
ggplot(data, aes(x=Life.expectancy, y=BMI))+
  geom_point()

impute_bmi <- function(values){
  l <- as.numeric(values[1])
  b <- as.numeric(values[2])
  if (is.na(b)){
    if (l<=50){
      return( 25.0)
    }
    else if (50<l && l<=60){
      return (25.0)
    }
    else if (60<l && l<=70){
      return (32.0)
    }
    else if (70<l && l<=80){
      return( 46.8)
    }
    else if (80<l && l<=100){
      return (60.0)
    }
  }
  else{
    return(b)
    }
}

life_bmi <- data[c('Life.expectancy','BMI')]
data$BMI <- apply(life_bmi, FUN=impute_bmi, MARGIN=1)
```


## Imputing Total Expenditure using Alcohol

```{r}
ggplot(data, aes(x= Total.expenditure, y=Alcohol))+
  geom_point(na.rm=TRUE)
impute_totalexp <- function(values){
  t<- as.numeric(values[1])
  a<- as.numeric(values[2])
  if( a<=2.5){
    return (5.08)}
  else if (2.5<a && a<=5.0){
    return (6.0)
  }
  else if (5.0<a && a<=10.0){
    return (6.71)
  }
  else if (10.0<a && a<=12.5){
    return (6.9)
  }
  else if (a>12.5){
    return (6.68)
  }
  else{
    return (t)
  }
}

alcohol_exp <- data[c('Total.expenditure','Alcohol')]
data$Total.expenditure <- apply(alcohol_exp, FUN=impute_totalexp, MARGIN=1)
```


## Imputing GDP with percentage expenditure

```{r}
ggplot(data,aes(x=percentage.expenditure, y=GDP))+
  geom_point(na.rm=TRUE)
impute_gdp<- function(values){
  p <- values[1]
  g <-values[2]
  if (is.na(g)){
    if (p<=1250){
    return (1100.0)}
  else if (1250<p && p<=2500){
    return (1800.0)}
  else if (2500<p && p<=3750){
    return (2900.0)}
  else if (3750<p && p<=7500){
    return (3500.0)}
  else if (7500<p && p<=8750){
    return (4500.0)}
  else if (8750<p && p<=10000){
    return (5000.0)}
  else if (10000<p && p<=11250){
    return (5700.0)}
  else if (11250<p && p<=12500){
    return (7000.0)}
  else if (12500<p && p<=15000){
    return (8000.0)}
  else if (15000<p && p<=17500){
    return (9000.0)}
  else if (p>17500){
    return (8500.0)}}
  else{
    return (g)}
}

percent_gdp <- data[c('percentage.expenditure','GDP')]
data$GDP <- apply(percent_gdp, FUN= impute_gdp, MARGIN=1)
```

## Imputing Population with infant deaths

```{r}
ggplot(data, aes(x=infant.deaths, y=Population))+
  geom_point(na.rm=TRUE)
impute_pop <- function(values){
  i<- as.numeric(values[1])
  p<- as.numeric(values[2])
  if (is.na(p)){
    if (i<=100){
    return( 0.19*((10)**9))}
  else if (100<i && i<=250){
    return( 0.18*((10)**9))}
  else if (250<i && i<=350){
    return( 0.02*((10)**9))}
  else if (350<i && i<=900){
    return( 0.1*((10)**9))}
  else if (900<i && i<=1100){
    return( 0.18*((10)**9))}
  else if (1100<i && i<=1250){
    return( 0.05*((10)**9))}
  else if (1250<i && i<=1500){
    return( 0.19*((10)**9))}
  else if (1500<i && i<=1750){
    return (0.05*((10)**9))}
  else if (i>1750){
    return (0.1*((10)**9))}}
  else{
    return (p)}
}
infant_pop <- data[c('infant.deaths','Population')]
data$Population <- apply(infant_pop, FUN=impute_pop, MARGIN=1)
```

## Imputing Thinness with BMI

```{r}
ggplot(data, aes(x=BMI, y=thinness..10.19.years))+
  geom_point(na.rm=TRUE)

impute_thinness <- function(values){
  b<- as.numeric(values[1])
  t<- as.numeric(values[2])
  if (is.na(t)){
    if (b<=10){
    return (5.0)}
  else if (10<b && b<=20){
    return (10.0)}
  else if (20<b && b<=30){
    return (8.0)}
  else if (30<b && b<=40){
    return (6.0)}
  else if (40<b && b<=50){
    return (3.0)}
  else if (50<b && b<=70){
    return (4.0)}
  else if (b>70){
    return (1.0)}}
  else{
    return (t)}
}

bmi_thin <- data[c('BMI','thinness..10.19.years')]
data$thinness..10.19.years <- apply(bmi_thin, FUN=impute_thinness, MARGIN=1)
```


## Imputing thinness 5-9 with BMI

```{r}
ggplot(data, aes(x=BMI, y=thinness.5.9.years))+
  geom_point(na.rm=TRUE)

impute_thin1 <- function(values){
  b <- as.numeric(values[1])
  t <- as.numeric(values[2])
  if(is.na(t)){
    if (b<=10){
      return( 5.0)}
    else if (10<b && b<=20){
      return (10.0)}
    else if (20<b && b<=30){
      return (8.0)}
    else if (30<b && b<=40){
      return (6.0)}
    else if (40<b && b<=50){
      return (3.0)}
    else if (50<b && b<=70){
      return (4.0)}
    else if (b>70){
      return (1.0)}
  }
  else{
    return(t)
  }
}

bmi_thin1 <- data[c('BMI','thinness.5.9.years')]
data$thinness.5.9.years <- apply(bmi_thin1, FUN = impute_thin1, MARGIN = 1)
```


## Imputing Income Composition of Resources with life expectancy

```{r}
ggplot(data, aes(x=Life.expectancy, y=Income.composition.of.resources))+
  geom_point(na.rm=TRUE)

impute_income <- function(values){
  l <- as.numeric( values[1])
  i <- as.numeric(values[2])
  if(is.na(i) == TRUE){
    if (l<=40){
      return (0.4)}
    else if (40<l && l<=50){
      return (0.42)}
    else if (50<l && l<=60){
      return (0.402)}
    else if (60<l && l<=70){
      return (0.54)}
    else if (70<l && l<=80){
      return (0.71)}
    else if (l>80){
      return (0.88)}
  }
  else{
    return(i)
  }
}

life_income <- data[c('Life.expectancy','Income.composition.of.resources')]
data$Income.composition.of.resources <- apply(life_income, FUN = impute_income, MARGIN = 1)
```


## Imputing Schooling with life expectancy

```{r}
ggplot(data, aes(x=Life.expectancy, y=Schooling))+
  geom_point(na.rm=TRUE)

impute_schooling <- function(values){
  l <- as.numeric(values[1])
  s <- as.numeric(values[2])
  if(is.na(s) == TRUE){
    if (l<= 40){
      return (8.0)}
    else if (40<l && l<=44 ){
      return (7.5)}
    else if (44<l && l<50 ){
      return (8.1)}
    else if (50<l && l<=60 ){
      return (8.2)}
    else if (60<l && l<=70 ){
      return (10.5)}
    else if (70<l && l<=80 ){
      return (13.4)}
    else if (l>80 ){
      return (16.5)}
  }
  else{
    return(s)
  }
}

life_school <- data[c('Life.expectancy', 'Schooling')]
data$Schooling <- apply(life_school, FUN=impute_schooling, MARGIN=1)
```


## Checking if there are any missing values after imputing

```{r}
sapply(data, FUN=function(x)(sum(is.na(x))))
```


# Data Pre-processing:

One Hot Encoding - allows the representation of categorical data to be more expressive. Many machine learning algorithms cannot work with categorical data directly. The categories must be converted into numbers.
Label Encoding - refers to converting the labels into numeric form so as to convert it into the machine-readable form. Machine learning algorithms can then decide in a better way on how those labels must be operated.



## Initializing label encoder for "Country" variable

```{r}
encoder <- LabelEncoder$new()
```


## Transforming the Country Variable

```{r}
data$Country <- encoder$fit_transform(data$Country)
```


## Excluding "Country" column and making "status" a one Hot Encoded Column

```{r}
dummy_var <- dummyVars(formula = '~.', data = data[-1])
oneHotData <- as.data.frame(predict(dummy_var, newdata=data[-1]))
colnames(oneHotData)
```


## Appending Country again in the one hot encoded dataset

```{r}
oneHotData$Country <- data$Country
colnames(oneHotData)
```

## Lets now split the data into Train & Test datasets

Creating sample size of 80% :

```{r}
set.seed(123)
sample_size <- floor(0.8*nrow(oneHotData))
```


## Creating train index by unbiased random sampling of data

```{r}
train_index <- sample(seq_len(nrow(oneHotData)), size=sample_size)
```

## Creating train dataset

```{r}
train<- oneHotData[train_index,]
```

## Creating Test dataset

```{r}
x_test<- oneHotData[-train_index,]
```

Creating different models for the dataset and checking which would be the best choice. We are rating our models on the basis of Root Mean Square Error (RMSE) score. We believe that depending on a specific problem, outliers can be significant in the overall analysis. So, that is why we chose RMSE over MAE. The thumb-rule is that Lesser the score, better the model is.

## Creating Linear Regression Model

```{r}
train_lm <- lm(Life.expectancy~., data=train)
summary(train_lm)
```

## Plotting the inferences of Linear regression model

```{r}
par(mfrow=c(2,2))
plot(train_lm)
```

## Predicting using the model

```{r}
predictions <- predict(train_lm, newdata=x_test)
paste(predictions)
```

## RMSE score of Linear Regression Model

```{r}
rmse.lm <- rmse(predictions,x_test$Life.expectancy)
rmse.lm
```

## Creating Decision Tree model

```{r}
model <- rpart(Life.expectancy~., data=train,method='anova')
```

## Plotting the decision Tree

```{r}
par(mfrow=c(1,1))
rpart.plot(model)
```

## Viewing the inferences of model with the node split details

```{r}
summary(model)
```

## Printing the Standard Error

```{r}
printcp(model)
```

## Plotting the standard error graph at per node split

```{r}
plotcp(model)
```

## Making Predictions using Decision Tree model

```{r}
predictions.tree <- predict(model, newdata = x_test)
```

## Checking the rmse score of Decision Tree

```{r}
rmse.tree <- rmse(predictions.tree,x_test$Life.expectancy)
rmse.tree
```


## Creating Random Forest Model

```{r}
forest <- randomForest(Life.expectancy~., data=train, ntree=100, mtry=2, 
                       importance=TRUE)
summary(forest)
plot(forest)
```


## Feature Importance according to random forest

```{r}
importance(forest)
```


## Plotting Variable Importance

```{r}
varImpPlot(forest)
```

## Predictions

```{r}
predictions.forest <- predict(forest,newdata=x_test)
```

## Evaluating RMSE Score

```{r}
rmse.forest <- rmse(predictions.forest, x_test$Life.expectancy)
rmse.forest
```


## Conclusion:
Random Forest produced least error implying greater accuracy.
Income Composition, HIV.Aids, Adult.Mortality are important variables.
From Analysis, it is clear that most people's Life Expectancy lies between 40-65 years
An Average person lives upto 69 years of age.
Almost for all the Developed countries, average life expectancy is more than 70 whereas it is less than 70 for more than half of the developing nations.

#-----------END----------------#






